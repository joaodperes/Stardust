<!DOCTYPE html>
<html>
<head>
    <title>Space Colony Manager</title>
    <style>
        /* CSS: This controls how the game looks */
        body { font-family: 'Courier New', monospace; background: #222; color: #eee; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; border: 1px solid #444; padding: 20px; }
        
        /* The header showing resources */
        .resource-bar { display: flex; justify-content: space-between; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 20px; }
        .res-item { font-size: 1.2em; font-weight: bold; }
        
        /* Building cards */
        .building { background: #333; padding: 15px; margin-bottom: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .building button { padding: 10px; cursor: pointer; background: #007bff; border: none; color: white; font-weight: bold; }
        .building button:disabled { background: #555; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="container">
    <h1>üöÄ Colony Command</h1>
        <div style="margin-bottom: 20px;">
        <button onclick="downloadSave()">üíæ Download Save</button>
        <input type="file" id="upload-input" style="display:none" onchange="uploadSave(event)">
        <button onclick="document.getElementById('upload-input').click()">üìÇ Upload Save</button>
    </div>
    
    <div class="resource-bar">
        <div class="res-item">Metal: <span id="metal-display">0</span></div>
        <div class="res-item">Income: <span id="income-display">0</span>/sec</div>
    </div>

    <div id="building-list">
        </div>
</div>

<script>
    // --- 1. THE DATA ---
    let gameData = {
        metal: 10,
        buildings: {
            mine: { name: "Metal Mine", level: 0, baseCost: 10, baseProd: 5 },
            solar: { name: "Solar Plant", level: 0, baseCost: 50, baseProd: 5 },
            crystal: { name: "Crystal Drill", level: 0, baseCost: 200, baseProd: 10 }
        },
        lastTick: Date.now()
    };

    // --- 2. THE LOGIC ---
    function getProduction() {
        let mineProd = gameData.buildings.mine.level * gameData.buildings.mine.baseProd;
        let solarProd = gameData.buildings.solar.level * gameData.buildings.solar.baseProd;
        let crystalProd = gameData.buildings.crystal.level * gameData.buildings.crystal.baseProd;
        return mineProd + solarProd + crystalProd;
    }

    function getCost(buildingKey) {
        let b = gameData.buildings[buildingKey];
        return Math.floor(b.baseCost * Math.pow(1.5, b.level));
    }

    function buyBuilding(key) {
        let cost = getCost(key);
        if (gameData.metal >= cost) {
            gameData.metal -= cost;
            gameData.buildings[key].level++;
            // We don't need to call a render function here anymore,
            // because the loop handles the text updates automatically!
        }
    }

    function saveGame() {
        localStorage.setItem("spaceColonySave", JSON.stringify(gameData));
    }

    function loadGame() {
        let savedGame = JSON.parse(localStorage.getItem("spaceColonySave"));
        if (savedGame !== null) {
            gameData = savedGame;
            let now = Date.now();
            let secondsOffline = (now - gameData.lastTick) / 1000;
            if (secondsOffline > 1) {
                let offlineIncome = getProduction() * secondsOffline;
                gameData.metal += offlineIncome;
                // alert("Welcome back..."); // Commented out to be less annoying while testing
            }
        }
    }

    // --- 3. THE UI SETUP (‚≠ê NEW PART) ---
    // We run this ONLY ONCE to create the buttons. 
    // We give specific IDs to the parts that need to change (cost, level, button).
    function createBuildingList() {
        let listHtml = "";
        for (let key in gameData.buildings) {
            let b = gameData.buildings[key];
            listHtml += `
            <div class="building">
                <div>
                    <strong>${b.name} (Lvl <span id="lvl-${key}">0</span>)</strong><br>
                    <small>Cost: <span id="cost-${key}">0</span> Metal</small>
                </div>
                <button id="btn-${key}" onclick="buyBuilding('${key}')">
                    Upgrade
                </button>
            </div>`;
        }
        document.getElementById("building-list").innerHTML = listHtml;
    }

    // --- 4. THE UI UPDATER (‚≠ê OPTIMIZED) ---
    // This runs 10 times a second. It ONLY updates numbers, it does not destroy HTML.
    function updateGUI() {
        // Update top bar
        document.getElementById("metal-display").innerText = Math.floor(gameData.metal);
        document.getElementById("income-display").innerText = getProduction();

        // Update each building's numbers without killing the button
        for (let key in gameData.buildings) {
            let b = gameData.buildings[key];
            let cost = getCost(key);
            let canAfford = gameData.metal >= cost;

            // Update the text using the IDs we created in createBuildingList
            document.getElementById(`lvl-${key}`).innerText = b.level;
            document.getElementById(`cost-${key}`).innerText = cost;
            
            // Toggle the button disabled state
            document.getElementById(`btn-${key}`).disabled = !canAfford;
        }
    }

    // --- 5. THE ENGINE ---
    // Initialize
    loadGame();
    createBuildingList(); // ‚≠ê Build the HTML once

    setInterval(function() {
        let now = Date.now();
        let deltaTime = (now - gameData.lastTick) / 1000;
        
        gameData.metal += getProduction() * deltaTime;
        gameData.lastTick = now;

        updateGUI(); // ‚≠ê Update the numbers

        // Auto-save roughly every 10 seconds
        // (Using a safer timestamp check)
        if (Date.now() - lastSaveTime > 10000) {
            saveGame();
            lastSaveTime = Date.now();
        }
    }, 100);

    let lastSaveTime = Date.now(); // helper for the auto-save

    // --- üíæ SAVE FILE MANAGEMENT ---
    function downloadSave() {
        // 1. Convert the game object to a pretty-printed string
        const dataStr = JSON.stringify(gameData, null, 2);
        
        // 2. Create a "Blob" (a file-like object)
        const blob = new Blob([dataStr], { type: "application/json" });
        
        // 3. Create a temporary link and "click" it automatically
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "colony_save.json";
        document.body.appendChild(link);
        link.click();
        
        // 4. Cleanup
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    function uploadSave(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const loadedData = JSON.parse(e.target.result);
                
                // ‚≠ê FIXED: Changed 'resources' to 'metal' to match your actual data
                if (loadedData.buildings && loadedData.metal !== undefined) {
                    gameData = loadedData;
                    
                    // IMPORTANT: Save it so it persists after the reload
                    localStorage.setItem("spaceColonySave", JSON.stringify(gameData));
                    
                    alert("Save loaded successfully!");
                    location.reload(); 
                } else {
                    alert("Invalid save file: Missing metal or buildings!");
                }
            } catch (err) {
                alert("Error: The file is not a valid JSON.");
            }
        };
        reader.readAsText(file);
    }

</script>
</body>
</html>
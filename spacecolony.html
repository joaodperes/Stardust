<!DOCTYPE html>
<html>
<head>
    <title>Space Colony Manager</title>
    <style>
        /* CSS: This controls how the game looks */
        body { font-family: 'Courier New', monospace; background: #222; color: #eee; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; border: 1px solid #444; padding: 20px; }
        
        /* The header showing resources */
        .resource-bar { display: flex; justify-content: space-between; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 20px; }
        .res-item { font-size: 1.2em; font-weight: bold; }
        
        /* Building cards */
        .building { background: #333; padding: 15px; margin-bottom: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .building button { padding: 10px; cursor: pointer; background: #007bff; border: none; color: white; font-weight: bold; }
        .building button:disabled { background: #555; cursor: not-allowed; }

        .resource-bar { 
            display: flex; 
            justify-content: space-around; 
            background: #111; 
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid #444; 
            margin-bottom: 20px; 
        }
        .res-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            text-align: center; 
        }
        .res-value { font-size: 1.1em; font-weight: bold; margin-bottom: 2px; }
        .res-label { font-size: 0.7em; text-transform: uppercase; color: #888; letter-spacing: 1px; }
        .res-item.warning .res-label, 
        .res-item.warning .res-value { 
            color: #ff4444 !important; 
        }
</style>
</head>
<body>

<div class="container">
    <h1>üöÄ Colony Command</h1>
        <div style="margin-bottom: 20px;">
        <button onclick="downloadSave()">üíæ Download Save</button>
        <input type="file" id="upload-input" style="display:none" onchange="uploadSave(event)">
        <button onclick="document.getElementById('upload-input').click()">üìÇ Upload Save</button>
    </div>
    
    <div class="resource-bar">
        <div class="res-item" id="metal-hover">
            <div class="res-value">üîò <span id="metal-display">0</span></div>
            <div class="res-label">Metal</div>
        </div>
        <div class="res-item" id="crystal-hover">
            <div class="res-value">üíé <span id="crystal-display">0</span></div>
            <div class="res-label">Crystal</div>
        </div>
        <div class="res-item" id="deuterium-hover">
            <div class="res-value">üß™ <span id="deuterium-display">0</span></div>
            <div class="res-label">Deuterium</div>
        </div>
        <div class="res-item">
            <div class="res-value">‚ö° <span id="energy-display">0</span>/<span id="max-energy-display">0</span></div>
            <div class="res-label">Energy</div>
        </div>
    </div>

    <div id="building-list">
        </div>
    <div id="construction-status" ...>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div>
                üèóÔ∏è <span id="build-name">None</span>: <span id="build-time">0</span>s
            </div>
            <button onclick="cancelConstruction()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px;">
                Cancel (50% Refund)
            </button>
        </div>
    </div>
    <div style="width: 100%; background: #111; height: 12px; border-radius: 6px; overflow: hidden;">
        <div id="build-progress-bar" style="width: 0%; height: 100%; background: #28a745; transition: width 0.1s linear;"></div>
    </div>
</div>
</div>

<script>
    // --- 1. THE DATA ---

    const icons = {
        metal: "üîò", // Or use an <img> tag like <img src='metal.png' width='20'>
        crystal: "üíé",
        deuterium: "üß™",
        energy: "‚ö°"
    };

    let gameData = {
        resources: {
            metal: 0,
            energy: 0,
            maxEnergy: 0,
            crystal: 0,
            deuterium: 0
        },
        buildings: {
            mine: { 
                name: "Metal Mine", level: 0, 
                cost: { metal: 10, crystal: 0, deuterium: 0 }, 
                baseProd: 5,
                baseTime: 15 
            },
            solar: { 
                name: "Solar Plant", level: 0, 
                cost: { metal: 30, crystal: 15, deuterium: 0 }, 
                baseProd: 5,
                baseTime: 20
            },
            crystal: { 
                name: "Crystal Drill", level: 0, 
                cost: { metal: 50, crystal: 20, deuterium: 0 }, 
                baseProd: 10,
                baseTime: 30,
            },
            deuterium: { 
                name: "Deuterium Synthesizer", level: 0, 
                cost: { metal: 150, crystal: 50, deuterium: 0 }, 
                baseProd: 1,
                baseTime: 60,
                req: {mine: 5, solar: 2}
            }
        },
        construction: {
            buildingKey: null, // Which building is being built?
            timeLeft: 0        // Seconds remaining
        },
        lastTick: Date.now()
    };

    // --- 2. THE LOGIC ---
    function getProduction() {
        if (!gameData.resources) return { metal: 0, crystal: 0, deuterium: 0 };

        gameData.resources.maxEnergy = gameData.buildings.solar.level * 10;
        let energyNeeded = (gameData.buildings.mine.level * 2) + 
                        (gameData.buildings.crystal.level * 1) + 
                        (gameData.buildings.deuterium.level * 3);
        
        gameData.resources.energy = gameData.resources.maxEnergy - energyNeeded;

        let efficiency = gameData.resources.energy < 0 ? 0.1 : 1.0;

        // Return an object with individual production values
        return {
            metal: (1 + (gameData.buildings.mine.level * gameData.buildings.mine.baseProd)) * efficiency,
            crystal: (gameData.buildings.crystal.level * gameData.buildings.crystal.baseProd) * efficiency,
            deuterium: (gameData.buildings.deuterium.level * gameData.buildings.deuterium.baseProd) * efficiency
        };
    }

    function getCost(key) {
        let b = gameData.buildings[key];
        let scale = Math.pow(1.5, b.level);
        return {
            metal: Math.floor(b.cost.metal * scale),
            crystal: Math.floor(b.cost.crystal * scale),
            deuterium: Math.floor(b.cost.deuterium * scale)
        };
    }

    function buyBuilding(key) {
        if (gameData.construction.buildingKey !== null) {
            alert("Construction site busy!");
            return;
        }

        console.log("Attempting to buy:", key);
        let costs = getCost(key);
        let r = gameData.resources;
        console.log("Calculated Costs:", costs);

        if (r.metal >= costs.metal && r.crystal >= costs.crystal && r.deuterium >= costs.deuterium) {
            r.metal -= costs.metal;
            r.crystal -= costs.crystal;
            r.deuterium -= costs.deuterium;

            let b = gameData.buildings[key];
            
            // Define totalTime first
            let calculatedTime = b.baseTime * Math.pow(1.2, b.level);
            
            gameData.construction.buildingKey = key;
            gameData.construction.timeLeft = calculatedTime;
            gameData.construction.totalTime = calculatedTime; 
            console.log("Construction started. Time left:", gameData.construction.timeLeft);
            saveGame();
        }
    }

    function cancelConstruction() {
        if (!gameData.construction.buildingKey) return;

        let key = gameData.construction.buildingKey;
        let bName = gameData.buildings[key].name;

        if (confirm(`Are you sure you want to cancel ${bName}? You will only get back 50% of the resources.`)) {
            let costs = getCost(key);
            
            // Refund 50%
            gameData.resources.metal += Math.floor(costs.metal * 0.5);
            gameData.resources.crystal += Math.floor(costs.crystal * 0.5);
            gameData.resources.deuterium += Math.floor(costs.deuterium * 0.5);

            // Reset construction
            gameData.construction.buildingKey = null;
            gameData.construction.timeLeft = 0;
            gameData.construction.totalTime = 0;

            saveGame();
            console.log("Construction cancelled and refunded.");
        }
    }

    function saveGame() {
        console.log("Saving game..."); 
        localStorage.setItem("spaceColonySave", JSON.stringify(gameData));
    }

    function loadGame() {
        let savedJSON = localStorage.getItem("spaceColonySave");
        if (!savedJSON) return;
        let savedGame = JSON.parse(savedJSON);

        // 1. Restore Resources safely (don't let undefined values in)
        if (savedGame.resources) {
            gameData.resources.metal = savedGame.resources.metal || 0;
            gameData.resources.crystal = savedGame.resources.crystal || 0;
            gameData.resources.deuterium = savedGame.resources.deuterium || 0;
            gameData.resources.energy = savedGame.resources.energy || 0;
        }

        // 2. Restore Building Levels
        for (let key in gameData.buildings) {
            if (savedGame.buildings && savedGame.buildings[key]) {
                gameData.buildings[key].level = savedGame.buildings[key].level || 0;
            }
        }

        // 3. Restore Construction State
        if (savedGame.construction) {
            gameData.construction = savedGame.construction;
        }

        // 4. Time Sync
        gameData.lastTick = savedGame.lastTick || Date.now();
        let now = Date.now();
        let deltaTime = (now - gameData.lastTick) / 1000;

        if (deltaTime > 1) {
            // If we were building something while offline, subtract that time
            if (gameData.construction.buildingKey) {
                gameData.construction.timeLeft -= deltaTime;
                if (gameData.construction.timeLeft < 0) gameData.construction.timeLeft = 0.1;
            }
            
            // Add offline resources
            let prod = getProduction();
            gameData.resources.metal += prod.metal * deltaTime;
            gameData.resources.crystal += prod.crystal * deltaTime;
            gameData.resources.deuterium += prod.deuterium * deltaTime;
        }
    }

    // --- 3. THE UI SETUP (‚≠ê NEW PART) ---
    // We run this ONLY ONCE to create the buttons. 
    // We give specific IDs to the parts that need to change (cost, level, button).
    function createBuildingList() {
        let listHtml = "";
        for (let key in gameData.buildings) {
            let b = gameData.buildings[key];
            listHtml += `
            <div class="building">
                <div>
                    <strong>${b.name} (Lvl <span id="lvl-${key}">0</span>)</strong><br>
                    <small id="cost-${key}">0 Metal</small>
                </div>
                <button id="btn-${key}" onclick="buyBuilding('${key}')">
                    Upgrade
                </button>
            </div>`;
        }
        document.getElementById("building-list").innerHTML = listHtml;
    }

    // --- 4. THE UI UPDATER ---
    // This runs 10 times a second. It ONLY updates numbers, it does not destroy HTML.
    function updateGUI() {
        // Update top bar
        const energyDisplay = document.getElementById("energy-display");
        energyDisplay.innerText = formatNum(gameData.resources.energy);
        energyDisplay.style.color = gameData.resources.energy < 0 ? "#ff4444" : "#00ff00"; //red if negative, green otherwise
        document.getElementById("max-energy-display").innerText = formatNum(gameData.resources.maxEnergy);

        document.getElementById("metal-display").innerText = formatNum(gameData.resources.metal);
        document.getElementById("crystal-display").innerText = formatNum(gameData.resources.crystal);
        document.getElementById("deuterium-display").innerText = formatNum(gameData.resources.deuterium);
        //document.getElementById("income-display").innerText = getProduction();

        let buildPanel = document.getElementById("construction-status");
        if (gameData.construction.buildingKey) {
            buildPanel.style.display = "block";
            buildPanel.querySelector("#build-name").innerText = gameData.buildings[gameData.construction.buildingKey].name;
            buildPanel.querySelector("#build-time").innerText = Math.ceil(gameData.construction.timeLeft);
        } else {
            buildPanel.style.display = "none";
        }

        let prod = getProduction(); 
        let r = gameData.resources;
        
        // Calculate current efficiency for the tooltip display
        let efficiency = r.energy < 0 ? 0.1 : 1.0;
        let effPercent = (efficiency * 100) + "%";
        let isLowPower = r.energy < 0;

        // --- Update Metal ---
        const metalHover = document.getElementById("metal-hover");
        metalHover.title = `Production: ${formatNum(prod.metal * 3600)} / hour\nEfficiency: ${effPercent}`;
        // Toggle the 'warning' class based on energy
        if (isLowPower) metalHover.classList.add("warning"); 
        else metalHover.classList.remove("warning");

        // --- Update Crystal ---
        const crystalHover = document.getElementById("crystal-hover");
        crystalHover.title = `Production: ${formatNum(prod.crystal * 3600)} / hour\nEfficiency: ${effPercent}`;
        if (isLowPower) crystalHover.classList.add("warning");
        else crystalHover.classList.remove("warning");

        // --- Update Deuterium ---
        const deutHover = document.getElementById("deuterium-hover");
        deutHover.title = `Production: ${formatNum(prod.deuterium * 3600)} / hour\nEfficiency: ${effPercent}`;
        if (isLowPower) deutHover.classList.add("warning");
        else deutHover.classList.remove("warning");

        // Update buttons: Disable if busy OR can't afford
        for (let key in gameData.buildings) {
            let b = gameData.buildings[key];           // Get the building data
            let costs = getCost(key);                  // Calculate current costs
            let r = gameData.resources;                // Shorthand for resources
            let isBusy = gameData.construction.buildingKey !== null;
            let canAfford = r.metal >= costs.metal && 
                        r.crystal >= costs.crystal && 
                        r.deuterium >= costs.deuterium;

            document.getElementById(`lvl-${key}`).innerText = b.level;
            
            // 1. Build the HTML string for costs with color coding
            let costHtml = "Cost: ";

            function getSpan(amount, current, icon) {
                let color = current >= amount ? "#00ff00" : "#ff4444";
                return `<span style="color: ${color}">${formatNum(amount)} ${icon}</span>`;
            }

            costHtml += getSpan(costs.metal, r.metal, icons.metal);
            if (costs.crystal > 0) costHtml += " | " + getSpan(costs.crystal, r.crystal, icons.crystal);
            if (costs.deuterium > 0) costHtml += " | " + getSpan(costs.deuterium, r.deuterium, icons.deuterium);

            // 2. Apply to the element
            let costLabel = document.getElementById(`cost-${key}`);
            costLabel.innerHTML = costHtml; // Use innerHTML because we are adding spans

            // 3. Update top bar numbers using formatNum
            document.getElementById("metal-display").innerText = formatNum(r.metal);
            document.getElementById("crystal-display").innerText = formatNum(r.crystal);
            document.getElementById("deuterium-display").innerText = formatNum(r.deuterium);

            let meetsReq = true;
            if (b.req) {
                for (let reqKey in b.req) {
                    if (gameData.buildings[reqKey].level < b.req[reqKey]) {
                        meetsReq = false;
                    }
                }
            }

            // Update the button state
            document.getElementById(`btn-${key}`).disabled = isBusy || !canAfford || !meetsReq;

            // Optional: Change the button text if requirements aren't met
            if (!meetsReq) {
                document.getElementById(`btn-${key}`).innerText = "Locked";
            } else {
                document.getElementById(`btn-${key}`).innerText = "Upgrade";
            }
        }

        if (gameData.construction.buildingKey) {
            buildPanel.style.display = "block";
            let progress = ((gameData.construction.totalTime - gameData.construction.timeLeft) / gameData.construction.totalTime) * 100;
            document.getElementById("build-progress-bar").style.width = progress + "%";
            document.getElementById("build-name").innerText = gameData.buildings[gameData.construction.buildingKey].name;
            document.getElementById("build-time").innerText = Math.ceil(gameData.construction.timeLeft);
        }
    }

    // --- 5. THE ENGINE ---
    // Initialize
    loadGame();
    createBuildingList(); // ‚≠ê Build the HTML once

    setInterval(function() {
        let now = Date.now();
        let deltaTime = (now - gameData.lastTick) / 1000;

        if (gameData.construction.buildingKey !== null) {
            gameData.construction.timeLeft -= deltaTime;

            // Is it finished?
            if (gameData.construction.timeLeft <= 0) {
                let key = gameData.construction.buildingKey;
                gameData.buildings[key].level++; // Level up!
                gameData.construction.buildingKey = null; // Clear the queue
                gameData.construction.timeLeft = 0;
                alert(gameData.buildings[key].name + " upgrade to level " + gameData.buildings[key].level + " completed!");
            }
        }
        
        // Get the production object
        let prod = getProduction();
        
        // Add each resource individually
        gameData.resources.metal += prod.metal * deltaTime;
        gameData.resources.crystal += prod.crystal * deltaTime;
        gameData.resources.deuterium += prod.deuterium * deltaTime;

        gameData.lastTick = now;
        updateGUI();

        if (Date.now() - lastSaveTime > 10000) {
            saveGame();
            lastSaveTime = Date.now();
        }
    }, 100);

    let lastSaveTime = Date.now(); // helper for the auto-save

    // --- üíæ SAVE FILE MANAGEMENT ---
    function downloadSave() {
        // 1. Convert the game object to a pretty-printed string
        const dataStr = JSON.stringify(gameData, null, 2);
        
        // 2. Create a "Blob" (a file-like object)
        const blob = new Blob([dataStr], { type: "application/json" });
        
        // 3. Create a temporary link and "click" it automatically
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "colony_save.json";
        document.body.appendChild(link);
        link.click();
        
        // 4. Cleanup
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    function uploadSave(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const loadedData = JSON.parse(e.target.result);
                
                if (loadedData.buildings && loadedData.resources && loadedData.resources.metal !== undefined) {
                    gameData = loadedData;
                    
                    // IMPORTANT: Save it so it persists after the reload
                    localStorage.setItem("spaceColonySave", JSON.stringify(gameData));
                    
                    alert("Save loaded successfully!");
                    location.reload(); 
                } else {
                    alert("Invalid save file: Missing metal or buildings!");
                }
            } catch (err) {
                alert("Error: The file is not a valid JSON.");
            }
        };
        reader.readAsText(file);
    }

    function formatNum(num) {
        // This adds the '.' or ',' depending on player's browser language
        return new Intl.NumberFormat('pt-PT').format(Math.floor(num));
    }

// Force a save when the user leaves the page or refreshes
window.addEventListener("beforeunload", function() {
    saveGame();
});

</script>
</body>
</html>